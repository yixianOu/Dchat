# å»ä¸­å¿ƒåŒ–èŠå¤©å®¤éœ€æ±‚ä¸å¼€å‘è®¡åˆ’

## è®¾è®¡æ–¹æ¡ˆ

### æ¶æ„æ¦‚è¿°
é‡‡ç”¨ **Gatewayé›†ç¾¤ + LeafNode** çš„æ··åˆæ¨¡å¼å®ç°å»ä¸­å¿ƒåŒ–èŠå¤©å®¤ï¼š
- æ¯ä¸ªåœ°ç†åŒºåŸŸéƒ¨ç½²ä¸€ä¸ªGatewayé›†ç¾¤ä½œä¸º"è¶…çº§èŠ‚ç‚¹"
- ç”¨æˆ·è®¾å¤‡é€šè¿‡LeafNodeè¿æ¥åˆ°æœ€è¿‘çš„Gatewayé›†ç¾¤
- Gatewayé›†ç¾¤é—´é€šè¿‡FRPå®ç°å…¬ç½‘äº’è¿

### NATSé›†ç¾¤æ–¹å¼é€‰æ‹©

#### 1. Gatewayé›†ç¾¤ (æ¨èä¸»æ¶æ„)
```
Region A          Region B          Region C
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Gateway Aâ”‚â—„â”€â”€â”€â”€â–ºâ”‚Gateway Bâ”‚â—„â”€â”€â”€â”€â–ºâ”‚Gateway Câ”‚
â”‚ Cluster â”‚      â”‚ Cluster â”‚      â”‚ Cluster â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â–²                â–²                â–²
     â”‚                â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚LeafNode â”‚      â”‚LeafNode â”‚      â”‚LeafNode â”‚
â”‚(Users)  â”‚      â”‚(Users)  â”‚      â”‚(Users)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŠ¿ï¼š**
- æ¶ˆæ¯åœ¨é›†ç¾¤é—´è‡ªåŠ¨è·¯ç”±ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
- æ”¯æŒä¸»é¢˜è®¢é˜…çš„å…¨å±€ä¼ æ’­
- å¯ä»¥å¤„ç†ç½‘ç»œåˆ†åŒºå’ŒèŠ‚ç‚¹æ•…éšœ
- LeafNodeå¯ä»¥åŠ¨æ€è¿æ¥åˆ°ä»»æ„Gatewayé›†ç¾¤

#### 2. FRPç«¯å£æ˜ å°„ç­–ç•¥
```ini
# Gatewayé›†ç¾¤èŠ‚ç‚¹é…ç½®
[gateway-7222]
type = tcp
local_port = 7222
remote_port = 17222  # å›ºå®šç«¯å£ï¼Œé¿å…é‡å¯å˜åŒ–

[cluster-6222] 
type = tcp
local_port = 6222
remote_port = 16222  # Gatewayé›†ç¾¤å†…éƒ¨é€šä¿¡ç«¯å£
```

### å…·ä½“å®ç°æ–¹æ¡ˆ

#### Phase 1: åŸºç¡€Gatewayé›†ç¾¤
1. **æ¯ä¸ªåŒºåŸŸéƒ¨ç½²3èŠ‚ç‚¹Gatewayé›†ç¾¤**
   - æä¾›é«˜å¯ç”¨æ€§
   - å†…éƒ¨ä½¿ç”¨ç§ç½‘é€šä¿¡
   - é€šè¿‡FRPæš´éœ²Gatewayç«¯å£åˆ°å…¬ç½‘

2. **æœåŠ¡å‘ç°æœºåˆ¶**
   ```json
   {
     "regions": {
       "asia": ["frp.server.com:17222", "frp.server.com:17223"],
       "europe": ["frp.eu.com:17222", "frp.eu.com:17223"],
       "america": ["frp.us.com:17222", "frp.us.com:17223"]
     }
   }
   ```

#### Phase 2: ç”¨æˆ·LeafNodeè¿æ¥
1. **å®¢æˆ·ç«¯å¯åŠ¨æµç¨‹**
   - è·å–æœåŠ¡å‘ç°é…ç½®
   - æµ‹è¯•å»¶è¿Ÿé€‰æ‹©æœ€è¿‘çš„Gatewayé›†ç¾¤
   - å»ºç«‹LeafNodeè¿æ¥

2. **æ¶ˆæ¯è·¯ç”±**
   - èŠå¤©å®¤æ¶ˆæ¯è‡ªåŠ¨åœ¨Gatewayé›†ç¾¤é—´ä¼ æ’­
   - ç”¨æˆ·åªéœ€è¿æ¥ä»»ä¸€å¯ç”¨çš„GatewayèŠ‚ç‚¹

#### Phase 3: é«˜çº§åŠŸèƒ½
1. **æ™ºèƒ½é‡è¿**
   - LeafNodeæ”¯æŒå¤šä¸ªGateway endpoint
   - è‡ªåŠ¨æ•…éšœè½¬ç§»åˆ°å…¶ä»–åŒºåŸŸ

2. **è´Ÿè½½å‡è¡¡**
   - æ ¹æ®ç”¨æˆ·åœ°ç†ä½ç½®åˆ†é…Gatewayé›†ç¾¤
   - åŠ¨æ€è°ƒæ•´è¿æ¥ç­–ç•¥

æ“ä½œè®°å½•ï¼š

- 2025-07-22ï¼šä¿®æ”¹cmd/LeafJWT/main.goï¼Œä¾æ¬¡æ‰§è¡Œ4æ¡nscå‘½ä»¤å¹¶æ‰“å°è¾“å‡ºã€‚
- 2025-07-21ï¼šä¿®æ”¹cmd/LeafJWT/main.goï¼Œæ•è·å¹¶æ‰“å°nscå‘½ä»¤(nsc push -a APP)çš„stdoutè¾“å‡ºã€‚
- 2025-07-06ï¼šæ·»åŠ é¡¹ç›®éœ€æ±‚ä¸å¼€å‘è®¡åˆ’

## æŠ€æœ¯ç»†èŠ‚

### Gatewayé›†ç¾¤é…ç½®ç¤ºä¾‹
```conf
# nats-gateway-asia.conf
port: 4222
server_name: "gateway-asia-1"

# Gatewayé…ç½®
gateway: {
  name: "asia"
  port: 7222
  gateways: [
    {name: "asia", urls: ["nats://localhost:7222"]},
    {name: "europe", urls: ["nats://frp.eu.com:17222"]},
    {name: "america", urls: ["nats://frp.us.com:17222"]}
  ]
}

# é›†ç¾¤é…ç½®(åŒºåŸŸå†…)
cluster: {
  port: 6222
  routes: [
    "nats://192.168.1.10:6222",
    "nats://192.168.1.11:6222"
  ]
}
```

### LeafNodeå®¢æˆ·ç«¯é…ç½®
```conf
# ç”¨æˆ·è®¾å¤‡NATSé…ç½®
port: 4223
leafnode: {
  remotes: [
    {urls: ["nats://frp.server.com:17222"]},  # äºšæ´²Gateway
    {urls: ["nats://frp.eu.com:17222"]},      # æ¬§æ´²Gateway
    {urls: ["nats://frp.us.com:17222"]}       # ç¾æ´²Gateway
  ]
}
```

### FRPé…ç½®ç­–ç•¥

#### é‡‡ç”¨éšæœºç«¯å£æ˜ å°„ + å®æ—¶æœåŠ¡å‘ç°

**FRPé…ç½®ç¤ºä¾‹ï¼š**
```ini
[common]
server_addr = frp.server.com
server_port = 7000
token = your_token

# éšæœºç«¯å£æ˜ å°„
[gateway]
type = tcp
local_port = 7222
# remote_port ä¸æŒ‡å®šï¼Œä½¿ç”¨éšæœºåˆ†é…

[cluster]
type = tcp
local_port = 6222
# remote_port ä¸æŒ‡å®šï¼Œä½¿ç”¨éšæœºåˆ†é…
```

**ä¼˜åŠ¿ï¼š**
- âœ… é›¶é…ç½®ï¼Œæ— ç«¯å£å†²çª
- âœ… FRPè‡ªåŠ¨ç®¡ç†ï¼Œç¨³å®šå¯é 
- âœ… æ”¯æŒå¤§è§„æ¨¡èŠ‚ç‚¹æ‰©å±•
- âœ… é™ä½è¿ç»´å¤æ‚åº¦

## å®ç°ä¼˜åŠ¿

### å»ä¸­å¿ƒåŒ–ç‰¹æ€§
- æ— å•ç‚¹æ•…éšœï¼šä»»ä¸€Gatewayé›†ç¾¤æ•…éšœä¸å½±å“å…¨å±€
- å°±è¿‘è¿æ¥ï¼šç”¨æˆ·è‡ªåŠ¨è¿æ¥æœ€è¿‘çš„Gatewayé›†ç¾¤
- æ¶ˆæ¯ä¼ æ’­ï¼šèŠå¤©æ¶ˆæ¯åœ¨æ‰€æœ‰Gatewayé›†ç¾¤é—´åŒæ­¥

### å¯æ‰©å±•æ€§
- æ°´å¹³æ‰©å±•ï¼šå¢åŠ æ–°çš„Gatewayé›†ç¾¤æ”¯æŒæ›´å¤šåŒºåŸŸ
- å¼¹æ€§ä¼¸ç¼©ï¼šé›†ç¾¤å†…èŠ‚ç‚¹å¯åŠ¨æ€å¢å‡
- è´Ÿè½½åˆ†æ•£ï¼šç”¨æˆ·åˆ†å¸ƒåœ¨ä¸åŒGatewayé›†ç¾¤

### FRPéšæœºç«¯å£ä¼˜åŠ¿
- é›¶é…ç½®ï¼šæ–°èŠ‚ç‚¹æ— éœ€ç«¯å£è§„åˆ’
- é«˜å¯ç”¨ï¼šFRPè‡ªåŠ¨å¤„ç†ç«¯å£åˆ†é…
- ç®€åŒ–è¿ç»´ï¼šå‡å°‘ç«¯å£å†²çªç®¡ç†

## Option

leafNode clusteræ— æ³•çƒ­æ›´æ–°,è€ƒè™‘mcp server
ä¸­å¿ƒåŒ–çš„frp(æš´éœ²clusterç«¯å£),å‘ç°é tlså…¬é’¥(æºå¸¦å…¬ç½‘clusterç«¯å£)
é—®é¢˜1:é‡å¯åæ˜ å°„çš„ç«¯å£ä¼šå˜,éœ€è¦é‡æ–°æ³¨å†Œå‘ç°(å¯ä»¥å°è¯•frpçš„apiæŸ¥è¯¢å’Œé€šé…ç¬¦å…¬é’¥)
å»ä¸­å¿ƒåŒ–,ä½†æ˜¯å„ä¸ªé›†ç¾¤å†…éƒ¨å¯ä»¥å¹¿æ’­è‡ªå·±çš„ä½ç½®(ç¾¤èŠåªéœ€åŠ å…¥ä¸€ä¸ªèŠ‚ç‚¹å¹¶è®¢é˜…subjectå³å¯)
æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯åŒä¸€ä¸ªé›†ç¾¤,åˆå§‹è¿æ¥ä¸ºæœåŠ¡å™¨èŠ‚ç‚¹,é€šè¿‡allow subjectå®ç°éš”ç¦»

## TODO
1. âœ… è®¾è®¡Gateway+LeafNodeæ··åˆæ¶æ„
2. âœ… ç®€åŒ–FRPç­–ç•¥ï¼šçº¯éšæœºç«¯å£+DHTæœåŠ¡å‘ç°
3. ğŸ”„ å®ç°Gatewayé›†ç¾¤Demo (cmd/superCluster)
4. â³ å®ç°FRP APIå®¢æˆ·ç«¯
5. â³ å¼€å‘DHTæœåŠ¡å‘ç°æœºåˆ¶
6. â³ å®ç°LeafNodeå®¢æˆ·ç«¯è¿æ¥
7. â³ é›†æˆæ¶ˆæ¯åŠ å¯†å’Œç”¨æˆ·è®¤è¯
8. â³ æ„å»ºèŠå¤©å®¤UIç•Œé¢