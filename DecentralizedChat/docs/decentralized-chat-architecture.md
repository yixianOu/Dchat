# 去中心化聊天室实现方案

## 1. 核心架构模型

### 1.1 P2P网络拓扑

采用**完全网状网络 (Full Mesh)**：

```
┌───┐     ┌───┐     ┌───┐
│ A │─────│ B │─────│ C │
└─┬─┘     └─┬─┘     └─┬─┘
  │         │         │
  └─────────┴─────────┘
```
- 每个节点直接连接其他所有节点
- 延迟最低，无需路由
- 适用于小型群组（<50人）

### 1.2 消息传播机制

采用**流言协议 (Gossip Protocol)**：

```
时间t0:  A ──msg──→ B
时间t1:  B ──msg──→ C,D
时间t2:  C ──msg──→ E,F
```
- 随机选择邻居传播
- 最终一致性保证
- 带宽效率高，容错性强

---

## 2. 身份与加密体系

### 2.1 去中心化身份 (DID)

```
┌─────────────────────────────────────────┐
│           用户身份生成流程                │
├─────────────────────────────────────────┤
│  1. 生成密钥对 (Ed25519)                 │
│     - 私钥: 本地安全存储                  │
│     - 公钥: 作为身份标识                  │
│                                         │
│  2. 身份验证                              │
│     - 挑战-响应机制                       │
│     - 签名证明私钥所有权                  │
└─────────────────────────────────────────┘
```

### 2.2 端到端加密 (E2EE)

采用**双重棘轮算法 (Double Ratchet)**：

```
初始握手 (X3DH):
┌─────┐                    ┌─────┐
│Alice│ ──IK_A, EK_A────→ │ Bob │
│     │ ←─────IK_B, EK_B── │     │
└─────┘                    └─────┘

消息加密:
┌─────────────┐
│  根密钥(RK)  │──→ 链密钥(CK) ──→ 消息密钥(MK)
└─────────────┘         │
    ↑                   ↓
    └──────── DH输出 ───┘
```
- 前向安全：泄露当前密钥不影响历史消息
- 后向安全：泄露当前密钥不影响未来消息
- 每条消息使用独立密钥

---

## 3. 消息存储与同步

### 3.1 存储策略

采用**本地优先 (Local-First)**：

```
┌─────────┐     ┌─────────┐     ┌─────────┐
│ DeviceA │     │ DeviceB │     │ DeviceC │
│ ┌─────┐ │     │ ┌─────┐ │     │ ┌─────┐ │
│ │DB_A │ │     │ │DB_B │ │     │ │DB_C │ │
│ └─────┘ │     │ └─────┘ │     │ └─────┘ │
└────┬────┘     └────┬────┘     └────┬────┘
     │               │               │
     └───────────────┼───────────────┘
                     │
              ┌─────────────┐
              │  可选: IPFS  │
              └─────────────┘
```
- 每个设备维护完整消息历史
- CRDT（无冲突复制数据类型）处理并发写入
- 可选的去中心化存储作为备份

消息数据结构（基于向量时钟）：
```javascript
{
  messageId: "uuid",
  sender: "public_key",
  content: "encrypted_payload",
  vectorClock: {
    "nodeA": 5,
    "nodeB": 3,
    "nodeC": 7
  },
  timestamp: 1700000000,
  signature: "sig"
}
```

### 3.2 消息可靠性

消息确认机制：
```
发送方          网络            接收方
  │    ──msg──→    │
  │                │    ──msg──→
  │                │
  │    ←─ack────   │    ←──ack───
  │←───────────────│
```

离线消息存储：
- 邻居节点代为缓存
- 消息发布到IPFS等去中心化存储

---

## 4. 网络传输层

### 4.1 NAT穿透

采用**STUN/TURN/ICE**：

```
┌─────────────────────────────────────────┐
│           NAT穿透流程                   │
├─────────────────────────────────────────┤
│                                         │
│  1. STUN: 获取公网地址                   │
│     Client ←──Public IP:Port──→ STUN    │
│                                         │
│  2. 尝试P2P直连                          │
│     A:port1 ←────────────→ B:port2      │
│                                         │
│  3. 失败则使用TURN中继                   │
│     A ←────→ TURN Server ←────→ B       │
│                                         │
└─────────────────────────────────────────┘
```

### 4.2 传输协议选择

采用**WebRTC**：
- 内置ICE，浏览器原生支持
- 适用于Web应用
- 需要信令服务器辅助建立连接

---

## 5. 群组管理

### 5.1 群组状态机

```
┌─────────┐   create   ┌─────────┐   join    ┌─────────┐
│  None   │───────────→│ Created │←──────────│  Member │
└─────────┘            └────┬────┘           └────┬────┘
                            │                     │
                            │ invite              │ leave
                            ↓                     ↓
                      ┌─────────┐           ┌─────────┐
                      │ Invited │──────────→│  Left   │
                      └─────────┘   accept  └─────────┘
```

### 5.2 权限模型

```
┌─────────────────────────────────────────┐
│           群组权限结构                  │
├─────────────────────────────────────────┤
│                                         │
│  Owner (创建者)                         │
│    ├── 解散群组                          │
│    ├── 转让所有权                        │
│    └── 所有Admin权限                     │
│                                         │
│  Admin (管理员)                         │
│    ├── 踢出成员                          │
│    ├── 设置权限                          │
│    └── 所有Member权限                    │
│                                         │
│  Member (普通成员)                      │
│    ├── 发送消息                          │
│    ├── 邀请成员（如允许）                 │
│    └── 查看历史                          │
│                                         │
└─────────────────────────────────────────┘
```

---

## 6. 安全考量

### 6.1 威胁防护

| 威胁 | 防护措施 |
|------|----------|
| 中间人攻击 | 证书固定，TOFU原则 |
| 重放攻击 | 时间戳+nonce，消息序号 |
| 元数据分析 | 填充，洋葱路由 |
| 女巫攻击 | 信任网络，PoW/PoS |
| 审查 | 域名前置，P2P路由 |

### 6.2 隐私保护

```
┌─────────────────────────────────────────┐
│           隐私保护层次                  │
├─────────────────────────────────────────┤
│                                         │
│  L1: 传输加密 (TLS/Noise)               │
│      ↓ 防止窃听                         │
│  L2: 内容加密 (E2EE)                    │
│      ↓ 服务器也无法读取                  │
│  L3: 元数据保护                         │
│      - 固定长度消息填充                  │
│      - 延迟发送/混合网络                 │
│      - 假流量生成                        │
│                                         │
└─────────────────────────────────────────┘
```

---

## 7. 推荐技术选型

针对小型私密群组（< 50人）：

```
网络层: WebRTC + Gossip协议
加密层: Double Ratchet (libsignal)
存储:   本地IndexedDB/SQLite
身份:   自托管Ed25519密钥对
```

---

## 8. 实现检查清单

- [ ] P2P网络连接建立
- [ ] 密钥生成与管理
- [ ] 端到端加密实现
- [ ] 消息可靠传输
- [ ] 离线消息处理
- [ ] 群组管理功能
- [ ] 消息历史同步
- [ ] 多设备支持
- [ ] 安全审计
- [ ] 性能优化
