# DecentralizedChat 开发任务清单

## 🎯 架构重构：分离服务端和客户端

### 背景

当前项目采用 Wails + Go 实现，将服务端（NATS Server）和客户端集成在一起。为了更好的去中心化架构和技术栈优势，计划分离为：

- **服务端**：纯NATS Routes集群节点（Go）
- **客户端**：独立聊天应用（Rust + Tauri）

---

## 📋 任务分解

### Phase 1: 服务端重构（NATS Routes 集群）

#### 1.1 核心功能
- [ ] **独立的NATS Server程序**
  - [ ] 移除JetStream依赖（仅使用NATS Core + Routes）
  - [ ] 纯内存转发，无状态设计
  - [ ] 支持Routes集群自动发现
  - [ ] 配置文件驱动启动

- [ ] **NSC认证系统**
  - [ ] 操作员（Operator）密钥管理
  - [ ] 账户（Account）权限配置
  - [ ] 用户JWT生成和验证
  - [ ] .creds文件生成工具

- [ ] **权限控制**
  - [ ] 配置发布/订阅权限模式
  - [ ] 主题隔离（dchat.dm.*/dchat.grp.*）
  - [ ] 防止跨用户消息窃听

- [ ] **部署工具**
  - [ ] Docker镜像打包
  - [ ] docker-compose快速部署
  - [ ] systemd服务配置
  - [ ] 健康检查端点

#### 1.2 移除功能
- [ ] ~~JetStream KV存储~~（移到客户端）
- [ ] ~~消息持久化~~（服务端无状态）
- [ ] ~~Wails集成~~
- [ ] ~~前端代码~~

---

### Phase 2: 客户端重构（Rust + Tauri）

#### 2.1 技术栈
- 后端: Rust + async-nats
- 框架: Tauri 2.x
- 数据库: SQLite (本地存储)
- 加密: RustCrypto (NaCl/AES-GCM)

#### 2.2 核心模块

**A. NATS客户端层**
- [ ] **连接管理**
  - [ ] 多服务器地址支持（自动故障转移）
  - [ ] NSC .creds认证
  - [ ] 自动重连机制
  - [ ] 连接状态监控

- [ ] **消息收发**
  - [ ] 发布/订阅封装
  - [ ] 主题管理（dchat.dm.*/dchat.grp.*）
  - [ ] 消息队列（保证顺序）

**B. 加密层**
- [ ] **密钥管理**
  - [ ] Ed25519身份密钥对生成
  - [ ] X25519加密密钥对生成
  - [ ] 密钥导入/导出
  - [ ] 密钥本地存储（加密保存）

- [ ] **加密实现**
  - [ ] NaCl Box私聊加密（X25519+XSalsa20-Poly1305）
  - [ ] AES-256-GCM群聊加密
  - [ ] 消息签名（Ed25519）

**C. 存储层**
- [ ] **SQLite数据库**
  - [ ] 用户身份表
  - [ ] 好友公钥表
  - [ ] 群组对称密钥表
  - [ ] 消息历史表
  - [ ] 配置表

**D. 业务逻辑层**
- [ ] **会话管理**
  - [ ] 私聊会话（CID派生）
  - [ ] 群聊会话
  - [ ] 会话列表
  - [ ] 未读消息计数

- [ ] **消息处理**
  - [ ] 消息发送流程
  - [ ] 消息接收解密
  - [ ] 消息历史查询
  - [ ] 消息搜索

- [ ] **好友/群组管理**
  - [ ] 添加好友（交换公钥）
  - [ ] 创建群组（生成对称密钥）
  - [ ] 邀请成员（密钥分发）

**E. Tauri命令接口**
- [ ] 用户管理命令
  - [ ] set_user_info
  - [ ] get_user
  - [ ] generate_keypair

- [ ] 会话命令
  - [ ] join_direct
  - [ ] join_group
  - [ ] get_conversations

- [ ] 消息命令
  - [ ] send_direct
  - [ ] send_group
  - [ ] get_messages

- [ ] 密钥管理命令
  - [ ] add_friend_key
  - [ ] add_group_key

---

### Phase 3: 集成测试

#### 3.1 服务端测试
- [ ] **单节点启动**
  - [ ] 配置加载测试
  - [ ] 监听端口测试
  - [ ] NSC认证测试

- [ ] **集群测试**
  - [ ] 2节点Routes连接
  - [ ] 3节点全连通
  - [ ] 消息转发验证
  - [ ] 节点故障恢复

- [ ] **权限测试**
  - [ ] 用户隔离验证
  - [ ] 主题权限控制
  - [ ] JWT过期处理

#### 3.2 客户端测试
- [ ] **本地功能**
  - [ ] 密钥生成和存储
  - [ ] 数据库读写
  - [ ] 加密解密正确性

- [ ] **网络功能**
  - [ ] 连接公网服务器
  - [ ] 消息发送接收
  - [ ] 多服务器故障转移

- [ ] **端到端测试**
  - [ ] 两客户端私聊
  - [ ] 多客户端群聊
  - [ ] 跨网络消息传递

---

### Phase 4: 部署和文档

#### 4.1 服务端部署
- [ ] **公网节点部署指南**
  - [ ] VPS选择建议
  - [ ] 防火墙配置
  - [ ] SSL/TLS证书
  - [ ] 监控和日志

- [ ] **Docker部署**
  - [ ] Dockerfile编写
  - [ ] docker-compose配置
  - [ ] 容器化部署文档

#### 4.2 客户端分发
- [ ] **打包构建**
  - [ ] Windows (.msi)
  - [ ] macOS (.dmg)
  - [ ] Linux (.AppImage/.deb)

- [ ] **自动更新**
  - [ ] Tauri updater配置
  - [ ] 版本检查机制

#### 4.3 文档完善
- [ ] **用户文档**
  - [ ] 安装指南
  - [ ] 快速入门
  - [ ] 密钥管理说明
  - [ ] 常见问题

- [ ] **开发文档**
  - [ ] 架构设计文档
  - [ ] API接口文档
  - [ ] 协议规范文档
  - [ ] 贡献指南

---

## 🎯 里程碑

### M1: 服务端重构（预计3天）
- ✅ 独立NATS Server程序（移除JetStream）
- ✅ Routes集群正常工作（已有实现）
- ✅ NSC认证系统（已有实现）
- ✅ Docker镜像打包

### M2: 客户端核心移植（预计5天）
- ✅ Tauri项目搭建
- ✅ NATS连接和认证（移植Go代码）
- ✅ 加密层实现（移植crypto.go）
- ✅ SQLite存储（替代JetStream KV）
- ✅ 私聊功能（移植service.go逻辑）

### M3: 功能完善（预计3天）
- ✅ 群聊功能（已有Go实现）
- ✅ 消息历史本地存储
- ✅ 密钥管理（移植到客户端）
- ✅ 配置管理

### M4: 测试与打包（预计3天）
- ✅ 端到端测试
- ✅ 集成测试
- ✅ 跨平台打包（Windows/macOS/Linux）
- ✅ 基础文档

**总计: 约2周（14天）**

---

## 🔮 Phase 5: 高级功能（未来规划）

### 5.1 用户自建节点支持（设想阶段）

#### 核心需求
- [ ] **客户端鉴权连接自建节点**
  - [ ] 支持用户导入.creds文件
  - [ ] 客户端优先连接自建节点
  - [ ] 自建节点不可达时自动回退到公共节点

- [ ] **客户端配置服务端**（可选）
  - [ ] 通过客户端管理界面配置自建节点
  - [ ] 动态修改服务端Routes配置

#### 简化方案
**方案**: 客户端管理API
- 客户端通过NATS请求/响应调用服务端管理API
- 服务端验证JWT权限后执行配置更新
- 配置变更后自动重载服务端

#### 开发优先级
- 🔴 **P0**: 暂不实现（M1-M4专注核心功能）
- 🟡 **P1**: M5阶段评估可行性

---

## 🔐 认证方案设计

### 背景
新架构下多个客户端共享公网NATS集群，需要区分用户身份并防止冒充。

### 方案A: NSC多账户体系（采用）

#### 架构
- 1个Operator（dchat-operator）
- 1个Account（dchat-users）
- N个User（每个客户端一个独立JWT）

#### 权限控制
- 用户只能访问自己的主题
- 主题格式: `dchat.dm.{cid}.*` / `dchat.grp.{gid}.*`

#### 用户流程
1. 首次启动生成Ed25519密钥对
2. 向服务端申请User JWT
3. 保存.creds文件到本地
4. 使用.creds连接任意公网节点

#### 实现任务
- [ ] 服务端预配置NSC Operator/Account
- [ ] 实现User JWT自动申请API
- [ ] 客户端.creds文件管理
- [ ] 主题权限隔离配置

---

## 📊 工作量评估

### 可直接复用的Go代码
- ✅ `internal/chat/service.go` - 核心逻辑清晰
- ✅ `internal/chat/crypto.go` - 加密算法实现
- ✅ `internal/nats/client.go` - NATS客户端封装
- ✅ `internal/routes/routes.go` - Routes集群管理
- ✅ `internal/config/config.go` - 配置管理

### 需要重写的部分
- 🔄 JetStream KV → SQLite（3天）
- 🔄 Go接口 → Rust Tauri命令（2天）
- 🔄 Wails绑定 → Tauri绑定（1天）

### 需要新增的部分
- ➕ 服务端移除JetStream配置（1天）
- ➕ 客户端SQLite数据库设计（已在Go中完成逻辑）
- ➕ 跨平台打包配置（1天）

---

## 🔧 技术决策

### 为什么移除JetStream？

**原因**：
1. ❌ 服务端不应存储用户数据（隐私）
2. ❌ JetStream增加复杂度和资源消耗
3. ❌ 公网节点应轻量级无状态
4. ✅ 客户端本地存储更安全

**替代方案**：
- 消息历史 → 客户端SQLite
- 密钥存储 → 客户端加密存储
- 离线消息 → 客户端在线时自动同步

### 为什么选择Rust + Tauri？

**优势**：
1. ✅ **性能**：Rust原生性能，低内存占用
2. ✅ **安全**：内存安全，无GC暂停
3. ✅ **体积**：比Electron小5-10倍
4. ✅ **生态**：RustCrypto、async-nats成熟
5. ✅ **跨平台**：一次编写，多平台运行

**对比Wails**：
- Wails: Go后端，适合快速原型
- Tauri: Rust后端，适合生产级应用
