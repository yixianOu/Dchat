# 去中心化聊天协议对比

## 协议概览

| 特性 | Matrix | Nostr | DecentralizedChat |
|------|--------|-------|-------------------|
| 架构 | 联邦制 | 中继制 | 公网集群+客户端 |
| 服务器 | Homeserver | Relay | NATS Routes集群 |
| E2EE | Olm/Megolm | 可选(NIP-04) | NaCl+AES-256-GCM |
| 元数据保护 | 有限 | 差 | 中等 |
| 离线消息 | 支持 | 依赖Relay | 支持(JetStream) |
| 群组规模 | 大 | 大 | 中 |
| NAT穿透 | 无需 | 无需 | 无需 |
| 移动端 | 良好 | 良好 | 良好 |

---

## Matrix 协议

### 核心概念

```
用户ID: @alice:example.com
房间ID: !roomid:example.com
```

### 架构特点

```
┌─────────────────────────────────────────────────────┐
│                   Matrix 联邦架构                    │
├─────────────────────────────────────────────────────┤
│                                                     │
│   ┌──────────┐     Federation      ┌──────────┐   │
│   │matrix.org│◄──────────────────►│gitter.im │   │
│   │  HS      │  Server-Server API  │  HS      │   │
│   └────┬─────┘                     └────┬─────┘   │
│        │                                │         │
│   ┌────┴─────┐                     ┌───┴──────┐  │
│   │ Clients  │                     │ Clients  │  │
│   └──────────┘                     └──────────┘  │
└─────────────────────────────────────────────────────┘
```

### 优点
- 成熟的生态系统
- 强大的群组功能
- 丰富的客户端选择
- 可自托管

### 缺点
- 元数据暴露给服务器
- Homeserver成为信任点
- 资源消耗较大

---

## Nostr 协议

### 核心概念

```
事件结构:
{
  "id": "<sha256哈希>",
  "pubkey": "<公钥>",
  "created_at": <时间戳>,
  "kind": <事件类型>,
  "content": "<内容>",
  "sig": "<签名>"
}
```

### 架构特点

```
┌─────────────────────────────────────────────────────┐
│                   Nostr 中继架构                     │
├─────────────────────────────────────────────────────┤
│                                                     │
│   用户A (npub1...)                                  │
│      │                                              │
│      ├──→ Relay 1 (wss://relay1.com) ──┐          │
│      ├──→ Relay 2 (wss://relay2.com) ──┼──→ 用户B │
│      └──→ Relay 3 (wss://relay3.com) ──┘          │
│                                                     │
│ 特点:                                               │
│ - 中继只转发，不存储身份                             │
│ - 用户选择多个中继                                   │
│ - 公钥即身份                                        │
│ - 简单，易于实现                                    │
└─────────────────────────────────────────────────────┘
```

### 优点
- 极简设计
- 无单点故障
- 抗审查
- 易于实现客户端

### 缺点
- 中继可以看到元数据
- 垃圾信息问题
- 无内置E2EE（依赖NIP扩展）

---

## DecentralizedChat 协议（本项目）

### 核心概念

```
用户ID: 自动生成UUID
身份密钥: Ed25519 (NSC)
消息加密: 
  - 私聊: X25519+XSalsa20-Poly1305 (NaCl)
  - 群聊: AES-256-GCM
```

### 架构特点

```
┌─────────────────────────────────────────────────────┐
│          NATS Routes 集群 + 客户端架构               │
├─────────────────────────────────────────────────────┤
│                                                     │
│  公网NATS Routes集群 (去中心化)                      │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐     │
│  │ Public-1 │◄──►│ Public-2 │◄──►│ Public-3 │     │
│  │  Server  │    │  Server  │    │  Server  │     │
│  └────┬─────┘    └────┬─────┘    └────┬─────┘     │
│       │               │               │            │
│       │    NATS Client 连接            │            │
│       │               │               │            │
│   ┌───┴───┐      ┌───┴───┐      ┌───┴───┐        │
│   │Client │      │Client │      │Client │        │
│   │  LA-1 │      │  LA-2 │      │  LB-1 │        │
│   └───────┘      └───────┘      └───────┘        │
│   局域网A         局域网A         局域网B           │
│                                                     │
│ 特点:                                               │
│ - 公网节点形成Routes全连通集群                       │
│ - 局域网客户端连接任意公网节点                       │
│ - 无需NAT穿透，主动连接公网                         │
│ - 消息通过Routes集群转发                            │
└─────────────────────────────────────────────────────┘
```

### 消息主题结构

```
dchat.dm.{cid}.msg     # 私聊消息 (CID = SHA256(uid1, uid2))
dchat.grp.{gid}.msg    # 群聊消息
```

### 消息格式

```json
{
  "cid": "会话ID",
  "sender": "发送者userID",
  "ts": 1234567890,
  "nonce": "base64随机数",
  "cipher": "base64密文"
}
```

### 核心模块

**1. internal/nats/client.go** - NATS客户端服务
- 多重认证支持 (JWT/.creds/Token)
- 自动重连和连接管理
- JetStream KV存储（密钥持久化）
- 发布订阅 + JSON序列化

**2. internal/chat/service.go** - 聊天服务核心
- 用户身份和密钥管理
- 端到端加密通信
- 实时消息订阅
- 懒加载密钥查询
- 事件驱动架构

**3. internal/routes/routes.go** - 节点管理
- 嵌入式NATS Server
- Routes集群配置
- NSC安全认证
- TLS证书管理

**4. internal/config/config.go** - 配置管理
- 用户配置
- 网络配置
- 权限配置

### 技术实现

**加密算法**
- 身份密钥: Ed25519 (NSC)
- 私聊加密: X25519 + XSalsa20-Poly1305 (NaCl)
- 群聊加密: AES-256-GCM
- 签名: Ed25519

**网络传输**
- 传输层: NATS protocol over TCP
- NAT穿透: 无需（客户端模式）
- 发现机制: 种子节点 + Routes自动发现
- 持久化: JetStream KV

**认证系统**
- 协议: NATS NSC + JWT
- 凭据: .creds 文件 (私钥 + JWT)
- 生命周期: 短期JWT + 自动续期

### 优点

1. **真正的去中心化**
   - 公网节点形成Routes全连通网络
   - 无单点故障
   - 用户可自建公网节点加入

2. **无需NAT穿透**
   - 局域网客户端主动连接公网节点
   - 避免复杂的打洞逻辑
   - 移动端友好

3. **企业级安全**
   - 端到端加密（NaCl/AES-256）
   - NSC身份认证系统
   - 密钥本地持久化

4. **高性能**
   - 懒加载架构
   - 内存缓存优化
   - 消息延迟 < 50ms

5. **开发友好**
   - Wails框架（Go+React）
   - 完整的前后端类型安全
   - 跨平台支持

### 缺点

1. **依赖公网节点**
   - 需要至少1个公网节点可达
   - 不是纯P2P（但公网层去中心化）

2. **相对新颖**
   - NATS在聊天领域应用较少
   - 生态不如Matrix成熟

3. **需要技术知识**
   - 自建公网节点需要服务器
   - 配置相对复杂

### 适用场景

- ✅ 需要真正去中心化的小型社区
- ✅ 技术用户/极客群体
- ✅ 企业内部加密通信
- ✅ 注重隐私的私密群组
- ❌ 大规模公开社交平台
- ❌ 非技术用户为主的场景

---

## 总结

### Matrix
- **定位**：企业级联邦式聊天平台
- **优势**：功能完整，生态成熟
- **劣势**：资源消耗大，Homeserver依赖

### Nostr
- **定位**：极简去中心化社交协议
- **优势**：简单易实现，灵活
- **劣势**：功能依赖扩展，元数据保护弱

### DecentralizedChat（本项目）
- **定位**：高性能企业级去中心化聊天
- **优势**：真正去中心化，无需NAT穿透，端到端加密
- **劣势**：需要公网节点，生态较新

**核心区别**：
- Matrix是"联邦制"（服务器互联）
- Nostr是"中继制"（轻量转发）
- DecentralizedChat是"混合制"（公网集群+客户端）

每种方案都有其适用场景，选择取决于具体需求和技术偏好。
