# 跨设备 P2P + NAT穿透测试指南

## 概述

本测试用于验证**两台位于不同局域网的设备**能否通过 NAT 穿透技术实现 P2P 直连。

## 网络架构

```
设备A (局域网1)                 互联网                  设备B (局域网2)
192.168.1.100:10001  <--->  NAT-A  <--->  NAT-B  <--->  192.168.2.100:10002
       |                                                    |
       |              信令服务器 (公网)                      |
       +-------------------> 121.199.173.116:8080 <---------+
```

## 前置条件

1. **两台设备**，位于不同局域网（例如：一台在家，一台在公司/学校）
2. **一台公网服务器**（用于部署信令服务器）
3. 所有设备都能访问互联网
4. 如果使用 Docker：**必须使用 `--network host` 模式**（详见下方 Docker 部署说明）

## 测试步骤

### 第一步：部署信令服务器

在公网服务器上执行：

```bash
cd test
go run signal_server.go -port 8080
```

或者使用脚本：

```bash
./run_p2p_test.sh server
```

信令服务器启动后会显示：
```
信令服务器启动: http://0.0.0.0:8080
API端点:
  POST /register - 注册节点
  GET  /query?peer_id=<id> - 查询节点
  ...
```

### 第二步：启动设备A

在**第一台设备**（局域网1）上执行：

```bash
cd test

# 方式1: 使用脚本
./run_p2p_test.sh device-a Alice

# 方式2: 直接运行
go run p2p_node.go \
    -node-id Alice \
    -listen-port 10001 \
    -signal-server http://<你的公网IP>:8080
```

设备A会：
1. 通过 STUN 获取自己的公网地址
2. 注册到信令服务器
3. 等待设备B连接

输出示例：
```
========================================
P2P NAT穿透测试节点
========================================
节点已创建: Alice
监听地址: 0.0.0.0:10001

正在通过STUN获取公网地址...
✅ 公网地址: 120.239.59.111:50001
   NAT类型: Cone NAT

正在注册到信令服务器...
✅ 已注册到信令服务器

========================================
节点ID: Alice
内网地址: 0.0.0.0:10001
公网地址: 120.239.59.111:50001
NAT类型: Cone NAT
连接状态: false
收到消息: 0
========================================

命令:
  s - 显示状态
  m <消息> - 发送消息给对等节点
  h - 再次打洞
  q - 退出
>
```

### 第三步：启动设备B

在**第二台设备**（局域网2）上执行：

```bash
cd test

# 方式1: 使用脚本
./run_p2p_test.sh device-b Bob Alice

# 方式2: 直接运行
go run p2p_node.go \
    -node-id Bob \
    -listen-port 10002 \
    -peer-id Alice \
    -signal-server http://<你的公网IP>:8080
```

设备B会：
1. 通过 STUN 获取自己的公网地址
2. 注册到信令服务器
3. 从信令服务器查询设备A的地址
4. 向设备A发送 UDP 打洞包
5. 尝试建立 P2P 连接

输出示例：
```
========================================
P2P NAT穿透测试节点
========================================
节点已创建: Bob
监听地址: 0.0.0.0:10002

正在通过STUN获取公网地址...
✅ 公网地址: 58.60.12.45:60002
   NAT类型: Cone NAT

正在注册到信令服务器...
✅ 已注册到信令服务器

正在查询对等节点 Alice...
✅ 找到对等节点:
   公网地址: 120.239.59.111:50001
   内网地址: 192.168.1.100:10001

🎯 开始UDP打洞到 Alice
   公网地址: 120.239.59.111:50001
   内网地址: 192.168.1.100:10001
   已发送打洞包

📨 收到打洞包 from Alice@120.239.59.111:50001
✅ 打洞确认 from Alice@120.239.59.111:50001

========================================
节点ID: Bob
内网地址: 0.0.0.0:10002
公网地址: 58.60.12.45:60002
NAT类型: Cone NAT
连接状态: true    <-- 连接成功！
收到消息: 0
========================================
```

### 第四步：验证P2P通信

**重要：需要双向打洞**

在设备B上：

```
> c Alice        # 连接到 Alice，执行打洞
🎯 开始UDP打洞到 Alice
   已发送打洞包

> s              # 检查连接状态
连接状态: true   <-- 应为 true
```

在设备A上：

```
> c Bob          # 同样要连接到 Bob，执行双向打洞
🎯 开始UDP打洞到 Bob
   已发送打洞包

> s              # 检查连接状态
连接状态: true
```

然后测试消息发送：

```
> m Hello Alice!
已发送: Hello Alice!
```

在设备A上会显示：

```
💬 [120.239.59.111:60002]: Hello Alice!
```

如果双方都能收到对方的消息，说明 **P2P NAT穿透成功！**

## 预期结果

### 成功情况 (Cone NAT)

```
设备A (Cone NAT) <---> 设备B (Cone NAT)

结果: ✅ P2P连接成功
      双向消息传输正常
      无需中继服务器
```

### 失败情况 (Symmetric NAT)

```
设备A (Symmetric NAT) <-X-> 设备B (任何NAT)

结果: ❌ P2P连接失败
      需要TURN中继服务器
```

## Docker 部署说明

如果使用 Docker 运行 P2P 节点，**必须使用 `--network host` 模式**：

```bash
# 设备 A
docker run -it --rm \
  --network host \
  p2p-node /p2p_node \
  -node-id Alice \
  -listen-port 10001 \
  -signal-server http://<公网IP>:8080

# 设备 B
docker run -it --rm \
  --network host \
  p2p-node /p2p_node \
  -node-id Bob \
  -listen-port 10002 \
  -signal-server http://<公网IP>:8080
```

**为什么必须使用 host 模式？**

Docker 的端口映射 (`-p 10001:10001/udp`) 会引入额外的 NAT 层，导致：
- 容器监听端口：`10001`
- STUN 获取的公网端口：随机端口（如 `2162`）
- 端口不一致 → 打洞失败

使用 `--network host` 模式，容器直接使用宿主机的网络栈，STUN 获取的端口与监听端口一致。

详见 [DOCKER_DEPLOY.md](./DOCKER_DEPLOY.md)

## 故障排查

### 问题1: 无法连接到信令服务器

**症状**: `注册失败: connection refused`

**解决**:
1. 检查信令服务器是否已启动
2. 检查防火墙是否放行了8080端口
3. 检查公网IP是否正确

### 问题2: STUN获取公网地址失败

**症状**: `获取公网地址失败: i/o timeout`

**解决**:
1. 检查网络连接
2. 检查防火墙是否阻止UDP出站
3. 尝试更换STUN服务器

### 问题3: 打洞成功但无法通信

**症状**: 收到打洞包，但发送消息失败

**可能原因**:
1. 防火墙阻止了UDP入站
2. NAT映射已过期
3. 地址解析错误

**解决**:
1. 在防火墙上放行相应端口
2. 增加保活包频率
3. 检查地址格式

### 问题4: 连接状态始终为 false

**症状**: 执行 `c <节点ID>` 后，`s` 显示 `连接状态: false`

**排查步骤**:
1. 检查双方是否都执行了 `c <对方ID>`（需要双向打洞）
2. 检查公网端口是否与监听端口一致（如果不一致，说明使用了 Docker 端口映射而非 host 模式）
3. 检查 NAT 类型是否为 Symmetric NAT
4. 检查防火墙是否阻止 UDP 入站

### 问题5: 公网端口与监听端口不一致（Docker）

**症状**:
```
监听地址: 0.0.0.0:10001
公网地址: 120.239.59.111:2162  <-- 端口不一致！
```

**原因**: 使用了 `-p 10001:10001/udp` 而非 `--network host`

**解决**: 改用 `--network host` 模式启动容器

### 问题6: 一方是Symmetric NAT

**症状**: 无法收到打洞包，连接始终失败

**原因**: Symmetric NAT会为每个目标分配不同端口，无法预测

**解决**: 需要使用TURN中继服务器（当前版本不支持）

## 测试报告模板

```markdown
## P2P NAT穿透测试报告

### 测试环境
- 设备A位置: (如: 家中)
- 设备B位置: (如: 公司)
- 信令服务器: (如: 阿里云ECS)

### 设备A信息
- 节点ID: Alice
- 内网地址: 192.168.1.100:10001
- 公网地址: 120.239.59.111:50001
- NAT类型: Cone NAT

### 设备B信息
- 节点ID: Bob
- 内网地址: 192.168.2.100:10002
- 公网地址: 58.60.12.45:60002
- NAT类型: Cone NAT

### 测试结果
- [x] STUN获取公网地址成功
- [x] 信令交换成功
- [x] UDP打洞成功
- [x] 双向P2P通信成功

### 结论
✅ P2P NAT穿透测试通过
```

## 进阶测试

### 测试不同NAT组合

| 设备A NAT | 设备B NAT | 预期结果 |
|-----------|-----------|----------|
| Cone      | Cone      | ✅ 成功  |
| Cone      | Port-Restricted | ⚠️ 可能成功 |
| Cone      | Symmetric | ❌ 失败  |
| Symmetric | Symmetric | ❌ 失败  |

### 测试网络切换

1. 设备A从WiFi切换到4G
2. 观察P2P连接是否自动恢复
3. 记录恢复时间

## 注意事项

1. **防火墙**: 确保防火墙允许UDP出站和入站
2. **超时**: NAT映射通常有几分钟超时，需要保活
3. **隐私**: 公网IP会暴露给对等节点
4. **安全**: 生产环境需要加密通信

## 相关文件

- `p2p_node.go` - P2P节点程序
- `signal_server.go` - 信令服务器
- `run_p2p_test.sh` - 测试脚本
